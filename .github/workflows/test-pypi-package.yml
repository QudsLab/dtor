name: Test PyPI Package

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version to test (e.g., 0.0.1)'
        required: false
        default: 'latest'

jobs:
  wait-for-pypi:
    name: "‚è≥ Wait for PyPI propagation"
    runs-on: ubuntu-latest
    steps:
    - name: Wait 5 minutes for PyPI to propagate
      run: |
        echo "Waiting 5 minutes for package to be available on PyPI..."
        sleep 300
    
    - name: Done waiting
      run: |
        echo "‚úÖ 5 minutes passed. Package should be available on PyPI now."

  test-pypi-install:
    name: "üêç Test on ${{ matrix.os }} - Python ${{ matrix.python-version }}"
    needs: wait-for-pypi
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
    
    steps:
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Upgrade pip
      run: python -m pip install --upgrade pip
    
    - name: Install package from PyPI
      run: |
        pip install dtor
    
    - name: Verify installation
      run: |
        python -c "import dtor; print('‚úÖ dtor imported successfully')"
        python -c "import dtor; print(f'Version: {dtor.__version__}')"
    
    - name: Check package metadata
      run: |
        pip show dtor
    
    - name: Test basic functionality
      run: |
        python -c "
        from dtor import TorHandler
        handler = TorHandler(recover=False)
        print('‚úÖ TorHandler initialized successfully')
        print(f'Binary dir: {handler.binary_dir}')
        print(f'SOCKS ports: {handler.socks_port}')
        print(f'Control ports: {handler.control_port}')
        "

  test-complete:
    name: "‚úÖ PyPI Package Tests Passed"
    runs-on: ubuntu-latest
    needs: test-pypi-install
    steps:
    - name: Success summary
      run: |
        echo "=========================================="
        echo "‚úÖ PyPI package tests completed successfully!"
        echo "=========================================="
        echo "Package 'dtor' is working correctly on:"
        echo "  üêß Linux (Ubuntu)"
        echo "  ü™ü Windows"
        echo "  üçé macOS"
        echo ""
        echo "Tested with Python 3.8, 3.9, 3.10, 3.11, 3.12"
        echo "=========================================="
        echo ""
        echo "Users can now safely install: pip install dtor"
        echo "=========================================="
